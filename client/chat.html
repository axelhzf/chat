<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title></title>
    <link rel="stylesheet" href="assets/less/main.css" type="text/css" media="screen">
</head>
<body>

<div class="wrapper">
    <div class="users">
        <div class="users-inner"></div>
    </div>
    <div class="center">
        <div class="conversation">
            
        </div>
        <div class="input">
            <div class="input-inner">
                <input id="data" type="text"/>
            </div>
        </div>
    </div>
</div>


<script src="vendor/jquery-1.7.2.js"></script>
<script src="vendor/underscore.js"></script>
<script src="vendor/backbone.js"></script>
<script src="vendor/socket.io.js"></script>
<script src="vendor/handlebars-1.0.0.beta.6.js"></script>

<script type="text/html" id="usersTmpl">
    {{#each users}}
    <div class="user">{{name}}</div>
    {{/each}}}
</script>

<script type="text/html" id="msgTmpl">
    <div class="chat-bubble {{color}}">
        <div class="chat-bubble-glare">
            <div class="chat-bubble-glare-inner"></div>
        </div>
        <strong>{{username}}</strong> ({{timestamp}}) : {{msg}}
        <div class="chat-bubble-arrow-border"></div>
        <div class="chat-bubble-arrow"></div>
    </div>
</script>

<script src="src/MessagesView.js"></script>
<script src="src/UsersView.js"></script>

<script>
    var App = App || {};

    //Model
    App.Config = Backbone.Model.extend({});
    App.Users = Backbone.Collection.extend({});
    App.Messages = Backbone.Collection.extend({});

    //Initialize
    App.config = new App.Config();
    App.users = new App.Users();
    App.messages = new App.Messages();
    App.usersView = new App.UsersView({collection : App.users, el : ".users-inner"});
    App.messagesView = new App.MessagesView({collection : App.messages, el : ".conversation", config : App.config});

    // Attach events
    App.users.on('reset', App.usersView.render);
    App.messages.on('add', App.messagesView.appendMsg);
    App.messages.on('reset', App.messagesView.render);

    var mode = "prod";
    if (mode === "dev") {
        var resetUsers = [];
        for (var i = 0; i < 4; i++) {
            resetUsers.push({name : 'axelhzf' + i});
        }
        users.reset(resetUsers);

        for (var i = 0; i < 100; i++) {
            var user = (i % 4) ? "axelhzf" : "atrivi";
            messages.add({username : user, timestamp : i, msg : 'hola'});
        }    
    }else{
        var socket = io.connect('http://localhost:3000');

        socket.on('connect', function () {
            var username = prompt("What's your name?");
            App.config.set('username', username);
            socket.emit('adduser', username);
        });

        socket.on("initchat", function (response) {
            App.messages.reset(response);
        });

        socket.on('updatechat', function (message) {
            App.messages.add(message);
        });

        socket.on('updateusers', function (data) {
            var names = _.keys(data);
            var newValues = _.map(names, function (name) {
                return {name : name};
            });
            App.users.reset(newValues);
        });        
    }

    // on load of page
    $(function () {
        var $input = $('#data');

        $input.focus();

        $input.keypress(function (e) {
            if (e.which == 13) {
                var message = $input.val();
                $input.val('');

                socket.emit('sendchat', message);
            }
        });
    });

</script>


</body>
</html>